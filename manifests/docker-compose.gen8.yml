version: '3.8'

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: transcript-pipeline-postgres
    restart: unless-stopped

    environment:
      # Load credentials from .env file
      POSTGRES_DB: ${POSTGRES_DB:-transcripts}
      POSTGRES_USER: ${POSTGRES_USER:-transcript_admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"

      # Performance tuning for 128GB RAM system with RAID10 SSD
      # Shared buffers: 25% of total RAM for caching
      POSTGRES_SHARED_BUFFERS: 32GB
      # Effective cache: Total RAM - shared_buffers (kernel + PG cache)
      POSTGRES_EFFECTIVE_CACHE_SIZE: 96GB
      # Work mem: RAM for sort/hash operations per connection
      POSTGRES_WORK_MEM: 512MB
      # Maintenance work mem: RAM for VACUUM, CREATE INDEX, ALTER TABLE
      POSTGRES_MAINTENANCE_WORK_MEM: 2GB
      # WAL configuration for replication readiness
      POSTGRES_WAL_LEVEL: replica
      POSTGRES_MAX_WAL_SENDERS: 3
      # Checkpoint tuning for write-heavy workloads
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: 0.9
      # Random page cost: 1.1 for SSD (default 4.0 is for spinning disks)
      POSTGRES_RANDOM_PAGE_COST: 1.1
      # Connection limits
      POSTGRES_MAX_CONNECTIONS: 100

    volumes:
      - /mnt/raid10/transcript-pipeline/pgdata:/var/lib/postgresql/data
      - ./sql/schema:/docker-entrypoint-initdb.d:ro

    ports:
      - "5432:5432"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-transcript_admin} -d ${POSTGRES_DB:-transcripts}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Security: Run as postgres user (UID 999)
    user: "999:999"

    # Resource limits (adjust based on workload)
    deploy:
      resources:
        limits:
          memory: 40G
        reservations:
          memory: 32G

    # Custom PostgreSQL configuration
    command:
      - postgres
      - -c
      - shared_buffers=32GB
      - -c
      - effective_cache_size=96GB
      - -c
      - work_mem=512MB
      - -c
      - maintenance_work_mem=2GB
      - -c
      - wal_level=replica
      - -c
      - max_wal_senders=3
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - random_page_cost=1.1
      - -c
      - max_connections=100
      - -c
      - shared_preload_libraries=pg_stat_statements
      - -c
      - log_destination=stderr
      - -c
      - logging_collector=on
      - -c
      - log_directory=/var/lib/postgresql/data/pg_log
      - -c
      - log_filename=postgresql-%Y-%m-%d.log
      - -c
      - log_rotation_age=1d
      - -c
      - log_truncate_on_rotation=on
      - -c
      - log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
      - -c
      - log_statement=mod
      - -c
      - log_min_duration_statement=1000

networks:
  default:
    name: transcript-pipeline
    driver: bridge
